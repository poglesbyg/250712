FROM node:18-alpine AS base

# Install dependencies
FROM base AS deps
RUN apk add --no-cache libc6-compat git
WORKDIR /app

# Copy all MCP server package files
COPY mcp-servers/git-analytics/package.json mcp-servers/git-analytics/package-lock.json* ./git-analytics/
COPY mcp-servers/code-quality/package.json mcp-servers/code-quality/package-lock.json* ./code-quality/
COPY mcp-servers/knowledge-graph/package.json mcp-servers/knowledge-graph/package-lock.json* ./knowledge-graph/

# Install dependencies for each server
RUN cd git-analytics && npm ci --only=production
RUN cd code-quality && npm ci --only=production
RUN cd knowledge-graph && npm ci --only=production

# Build stage
FROM base AS builder
WORKDIR /app

# Copy dependencies
COPY --from=deps /app/git-analytics/node_modules ./git-analytics/node_modules
COPY --from=deps /app/code-quality/node_modules ./code-quality/node_modules
COPY --from=deps /app/knowledge-graph/node_modules ./knowledge-graph/node_modules

# Copy source code
COPY mcp-servers/git-analytics/ ./git-analytics/
COPY mcp-servers/code-quality/ ./code-quality/
COPY mcp-servers/knowledge-graph/ ./knowledge-graph/

# Build each server
RUN cd git-analytics && npm run build
RUN cd code-quality && npm run build
RUN cd knowledge-graph && npm run build

# Production stage
FROM base AS runner
WORKDIR /app

# Install git for repository analysis
RUN apk add --no-cache git

ENV NODE_ENV production

# Create non-root user
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nodejs

# Copy built applications
COPY --from=builder --chown=nodejs:nodejs /app/git-analytics ./git-analytics
COPY --from=builder --chown=nodejs:nodejs /app/code-quality ./code-quality
COPY --from=builder --chown=nodejs:nodejs /app/knowledge-graph ./knowledge-graph

# Create startup script
COPY --chown=nodejs:nodejs <<EOF /app/start-mcp-servers.sh
#!/bin/sh
echo "Starting MCP servers..."

# Start Git Analytics server
cd /app/git-analytics && node dist/index.js &
GIT_PID=\$!

# Start Code Quality server
cd /app/code-quality && node dist/index.js &
CODE_PID=\$!

# Start Knowledge Graph server
cd /app/knowledge-graph && node dist/index.js &
KNOWLEDGE_PID=\$!

echo "MCP servers started:"
echo "- Git Analytics (PID: \$GIT_PID)"
echo "- Code Quality (PID: \$CODE_PID)"
echo "- Knowledge Graph (PID: \$KNOWLEDGE_PID)"

# Wait for all processes
wait \$GIT_PID \$CODE_PID \$KNOWLEDGE_PID
EOF

RUN chmod +x /app/start-mcp-servers.sh

USER nodejs

EXPOSE 8001 8002 8003

CMD ["/app/start-mcp-servers.sh"] 